---
{"kind": "pipeline", "type": "docker", "name": "pr-test", "trigger": {"event": ["pull_request"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "lint-drone", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["./bin/grabpl verify-drone"], "depends_on": ["grabpl"]}, {"name": "codespell", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["echo -e \"unknwon\nreferer\nerrorstring\neror\niam\nwan\" \u003e words_to_ignore.txt", "codespell -I words_to_ignore.txt docs/", "rm words_to_ignore.txt"]}, {"name": "shellcheck", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl shellcheck"]}, {"name": "lint-backend", "image": "grafana/build-container:1.4.9", "environment": {"CGO_ENABLED": "1"}, "depends_on": ["initialize"], "commands": ["./bin/grabpl lint-backend --edition oss"]}, {"name": "lint-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run prettier:check", "yarn run lint", "yarn run i18n:compile", "yarn run typecheck"]}, {"name": "test-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl test-backend --edition oss"]}, {"name": "test-backend-integration", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl integration-tests --edition oss"]}, {"name": "test-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run ci:test-frontend"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-build-e2e", "trigger": {"event": ["pull_request"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "build-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {}, "commands": ["./bin/grabpl build-backend --jobs 8 --edition oss --build-id ${DRONE_BUILD_NUMBER} --variants linux-x64,linux-x64-musl,osx64,win64,armv6 --no-pull-enterprise"]}, {"name": "build-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "commands": ["./bin/grabpl build-frontend --jobs 8 --no-install-deps --edition oss --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise"]}, {"name": "build-plugins", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": null, "commands": ["./bin/grabpl build-plugins --jobs 8 --edition oss --no-install-deps"]}, {"name": "validate-scuemata", "image": "grafana/build-container:1.4.9", "depends_on": ["build-backend"], "commands": ["./bin/linux-amd64/grafana-cli cue validate-schema --grafana-root ."]}, {"name": "ensure-cuetsified", "image": "grafana/build-container:1.4.9", "depends_on": ["validate-scuemata"], "commands": ["# Make sure the git tree is clean.", "# Stashing changes, since packages that were produced in build-backend step are needed.", "git stash", "./bin/linux-amd64/grafana-cli cue gen-ts --grafana-root .", "# The above command generates Typescript files (*.gen.ts) from all appropriate .cue files.", "# It is required that the generated Typescript be in sync with the input CUE files.", "# ...Modulo eslint auto-fixes...:", "yarn run eslint . --ext .gen.ts --fix", "# If any filenames are emitted by the below script, run the generator command `grafana-cli cue gen-ts` locally and commit the result.", "./scripts/clean-git-or-error.sh", "# Un-stash changes.", "git stash pop"]}, {"name": "package", "image": "grafana/build-container:1.4.9", "depends_on": ["build-plugins", "build-backend", "build-frontend"], "environment": null, "commands": [". scripts/build/gpg-test-vars.sh && ./bin/grabpl package --jobs 8 --edition oss --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise --variants linux-x64,linux-x64-musl,osx64,win64,armv6"]}, {"name": "grafana-server", "image": "grafana/build-container:1.4.9", "detach": true, "depends_on": ["build-plugins", "build-backend", "build-frontend"], "environment": {"PORT": 3001, "ARCH": "linux-amd64"}, "commands": ["./scripts/grafana-server/start-server"]}, {"name": "end-to-end-tests-dashboards-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite dashboards-suite"]}, {"name": "end-to-end-tests-smoke-tests-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite smoke-tests-suite"]}, {"name": "end-to-end-tests-panels-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite panels-suite"]}, {"name": "end-to-end-tests-various-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite various-suite"]}, {"name": "e2e-tests-artifacts-upload", "image": "google/cloud-sdk:367.0.0", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "when": {"status": ["success", "failure"]}, "environment": {"GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY": {"from_secret": "gcp_upload_artifacts_key"}, "E2E_TEST_ARTIFACTS_BUCKET": "releng-pipeline-artifacts-dev", "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apt-get update", "apt-get install -yq zip", "ls -lah ./e2e", "find ./e2e -type f -name \"*.mp4\"", "printenv GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY > /tmp/gcpkey_upload_artifacts.json", "gcloud auth activate-service-account --key-file=/tmp/gcpkey_upload_artifacts.json", "find ./e2e -type f -name \"*spec.ts.mp4\" | zip e2e/videos.zip -@", "gsutil cp e2e/videos.zip gs://$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "export E2E_ARTIFACTS_VIDEO_ZIP=https://storage.googleapis.com/$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "echo \"E2E Test artifacts uploaded to: $${E2E_ARTIFACTS_VIDEO_ZIP}\"", "curl -X POST https://api.github.com/repos/${DRONE_REPO}/statuses/${DRONE_COMMIT_SHA} -H \"Authorization: token $${GITHUB_TOKEN}\" -d \"{\\\"state\\\":\\\"success\\\",\\\"target_url\\\":\\\"$${E2E_ARTIFACTS_VIDEO_ZIP}\\\", \\\"description\\\": \\\"Click on the details to download e2e recording videos\\\", \\\"context\\\": \\\"e2e_artifacts\\\"}\""]}, {"name": "build-storybook", "image": "grafana/build-container:1.4.9", "depends_on": ["build-frontend"], "environment": {"NODE_OPTIONS": "--max_old_space_size=4096"}, "commands": ["yarn storybook:build", "./bin/grabpl verify-storybook"]}, {"name": "test-a11y-frontend", "image": "grafana/docker-puppeteer:1.0.0", "depends_on": ["grafana-server"], "environment": {"GRAFANA_MISC_STATS_API_KEY": {"from_secret": "grafana_misc_stats_api_key"}, "HOST": "grafana-server", "PORT": 3001}, "failure": "always", "commands": ["yarn wait-on http://$HOST:$PORT", "pa11y-ci --config .pa11yci-pr.conf.js"]}, {"name": "build-frontend-docs", "image": "grafana/build-container:1.4.9", "depends_on": ["build-frontend"], "commands": ["./scripts/ci-reference-docs-lint.sh ci"]}, {"name": "build-docs-website", "image": "grafana/docs-base:latest", "depends_on": ["build-frontend-docs"], "commands": ["mkdir -p /hugo/content/docs/grafana", "cp -r docs/sources/* /hugo/content/docs/grafana/latest/", "cd /hugo && make prod"]}, {"name": "copy-packages-for-docker", "image": "grafana/build-container:1.4.9", "depends_on": ["package"], "commands": ["ls dist/*.tar.gz*", "cp dist/*.tar.gz* packaging/docker/"]}, {"name": "build-docker-images", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition oss -archs amd64"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-integration-tests", "trigger": {"event": ["pull_request"]}, "services": [{"name": "postgres", "image": "postgres:12.3-alpine", "environment": {"POSTGRES_USER": "grafanatest", "POSTGRES_PASSWORD": "grafanatest", "POSTGRES_DB": "grafanatest", "PGDATA": "/var/lib/postgresql/data/pgdata"}, "volumes": [{"name": "postgres", "path": "/var/lib/postgresql/data/pgdata"}]}, {"name": "mysql", "image": "mysql:5.6.48", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql", "path": "/var/lib/mysql"}]}], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "postgres-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["grabpl"], "environment": {"PGPASSWORD": "grafanatest", "GRAFANA_TEST_DB": "postgres", "POSTGRES_HOST": "postgres"}, "commands": ["apt-get update", "apt-get install -yq postgresql-client", "dockerize -wait tcp://postgres:5432 -timeout 120s", "psql -p 5432 -h postgres -U grafanatest -d grafanatest -f devenv/docker/blocks/postgres_tests/setup.sql", "go clean -testcache", "./bin/grabpl integration-tests --database postgres"]}, {"name": "mysql-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["grabpl"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql"}, "commands": ["apt-get update", "apt-get install -yq default-mysql-client", "dockerize -wait tcp://mysql:3306 -timeout 120s", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql -P 3306 -u root -prootpass", "go clean -testcache", "./bin/grabpl integration-tests --database mysql"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "test-docs-pr", "trigger": {"event": {"include": ["pull_request"]}, "paths": {"include": ["docs/**"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "lint-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run prettier:check", "yarn run lint", "yarn run i18n:compile", "yarn run typecheck"]}, {"name": "test-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run ci:test-frontend"]}, {"name": "build-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "commands": ["./bin/grabpl build-frontend --jobs 8 --no-install-deps --edition oss --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise"]}, {"name": "build-storybook", "image": "grafana/build-container:1.4.9", "depends_on": ["build-frontend"], "environment": {"NODE_OPTIONS": "--max_old_space_size=4096"}, "commands": ["yarn storybook:build", "./bin/grabpl verify-storybook"]}, {"name": "build-frontend-docs", "image": "grafana/build-container:1.4.9", "depends_on": ["build-frontend"], "commands": ["./scripts/ci-reference-docs-lint.sh ci"]}, {"name": "build-docs-website", "image": "grafana/docs-base:latest", "depends_on": ["build-frontend-docs"], "commands": ["mkdir -p /hugo/content/docs/grafana", "cp -r docs/sources/* /hugo/content/docs/grafana/latest/", "cd /hugo && make prod"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-test", "trigger": {"event": ["push"], "branch": "main"}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "lint-drone", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["./bin/grabpl verify-drone"], "depends_on": ["grabpl"]}, {"name": "codespell", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["echo -e \"unknwon\nreferer\nerrorstring\neror\niam\nwan\" \u003e words_to_ignore.txt", "codespell -I words_to_ignore.txt docs/", "rm words_to_ignore.txt"]}, {"name": "shellcheck", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl shellcheck"]}, {"name": "lint-backend", "image": "grafana/build-container:1.4.9", "environment": {"CGO_ENABLED": "1"}, "depends_on": ["initialize"], "commands": ["./bin/grabpl lint-backend --edition oss"]}, {"name": "lint-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run prettier:check", "yarn run lint", "yarn run i18n:compile", "yarn run typecheck"]}, {"name": "test-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl test-backend --edition oss"]}, {"name": "test-backend-integration", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl integration-tests --edition oss"]}, {"name": "test-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run ci:test-frontend"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-build-e2e-publish", "trigger": {"event": ["push"], "branch": "main"}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "trigger-enterprise-downstream", "image": "grafana/drone-downstream", "settings": {"server": "https://drone.grafana.net", "token": {"from_secret": "drone_token"}, "repositories": ["grafana/grafana-enterprise@main"], "params": ["SOURCE_BUILD_NUMBER=${DRONE_BUILD_NUMBER}", "SOURCE_COMMIT=${DRONE_COMMIT}"]}}, {"name": "build-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {}, "commands": ["./bin/grabpl build-backend --jobs 8 --edition oss --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise"]}, {"name": "build-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "commands": ["./bin/grabpl build-frontend --jobs 8 --no-install-deps --edition oss --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise"]}, {"name": "build-plugins", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}}, "commands": ["./bin/grabpl build-plugins --jobs 8 --edition oss --no-install-deps --sign --signing-admin"]}, {"name": "validate-scuemata", "image": "grafana/build-container:1.4.9", "depends_on": ["build-backend"], "commands": ["./bin/linux-amd64/grafana-cli cue validate-schema --grafana-root ."]}, {"name": "ensure-cuetsified", "image": "grafana/build-container:1.4.9", "depends_on": ["validate-scuemata"], "commands": ["# Make sure the git tree is clean.", "# Stashing changes, since packages that were produced in build-backend step are needed.", "git stash", "./bin/linux-amd64/grafana-cli cue gen-ts --grafana-root .", "# The above command generates Typescript files (*.gen.ts) from all appropriate .cue files.", "# It is required that the generated Typescript be in sync with the input CUE files.", "# ...Modulo eslint auto-fixes...:", "yarn run eslint . --ext .gen.ts --fix", "# If any filenames are emitted by the below script, run the generator command `grafana-cli cue gen-ts` locally and commit the result.", "./scripts/clean-git-or-error.sh", "# Un-stash changes.", "git stash pop"]}, {"name": "package", "image": "grafana/build-container:1.4.9", "depends_on": ["build-plugins", "build-backend", "build-frontend"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "GPG_PRIV_KEY": {"from_secret": "gpg_priv_key"}, "GPG_PUB_KEY": {"from_secret": "gpg_pub_key"}, "GPG_KEY_PASSWORD": {"from_secret": "gpg_key_password"}}, "commands": ["./bin/grabpl package --jobs 8 --edition oss --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise --sign"]}, {"name": "grafana-server", "image": "grafana/build-container:1.4.9", "detach": true, "depends_on": ["build-plugins", "build-backend", "build-frontend"], "environment": {"PORT": 3001, "ARCH": "linux-amd64"}, "commands": ["./scripts/grafana-server/start-server"]}, {"name": "end-to-end-tests-dashboards-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite dashboards-suite"]}, {"name": "end-to-end-tests-smoke-tests-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite smoke-tests-suite"]}, {"name": "end-to-end-tests-panels-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite panels-suite"]}, {"name": "end-to-end-tests-various-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite various-suite"]}, {"name": "e2e-tests-artifacts-upload", "image": "google/cloud-sdk:367.0.0", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "when": {"status": ["success", "failure"]}, "environment": {"GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY": {"from_secret": "gcp_upload_artifacts_key"}, "E2E_TEST_ARTIFACTS_BUCKET": "releng-pipeline-artifacts-dev", "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apt-get update", "apt-get install -yq zip", "ls -lah ./e2e", "find ./e2e -type f -name \"*.mp4\"", "printenv GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY > /tmp/gcpkey_upload_artifacts.json", "gcloud auth activate-service-account --key-file=/tmp/gcpkey_upload_artifacts.json", "find ./e2e -type f -name \"*spec.ts.mp4\" | zip e2e/videos.zip -@", "gsutil cp e2e/videos.zip gs://$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "export E2E_ARTIFACTS_VIDEO_ZIP=https://storage.googleapis.com/$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "echo \"E2E Test artifacts uploaded to: $${E2E_ARTIFACTS_VIDEO_ZIP}\"", "curl -X POST https://api.github.com/repos/${DRONE_REPO}/statuses/${DRONE_COMMIT_SHA} -H \"Authorization: token $${GITHUB_TOKEN}\" -d \"{\\\"state\\\":\\\"success\\\",\\\"target_url\\\":\\\"$${E2E_ARTIFACTS_VIDEO_ZIP}\\\", \\\"description\\\": \\\"Click on the details to download e2e recording videos\\\", \\\"context\\\": \\\"e2e_artifacts\\\"}\""]}, {"name": "build-storybook", "image": "grafana/build-container:1.4.9", "depends_on": ["build-frontend"], "environment": {"NODE_OPTIONS": "--max_old_space_size=4096"}, "commands": ["yarn storybook:build", "./bin/grabpl verify-storybook"]}, {"name": "store-storybook", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["build-storybook", "end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["printenv GCP_KEY | base64 -d > /tmp/gcpkey.json", "gcloud auth activate-service-account --key-file=/tmp/gcpkey.json", "gsutil -m rsync -d -r ./packages/grafana-ui/dist/storybook gs://$${PRERELEASE_BUCKET}/artifacts/storybook/canary"]}, {"name": "test-a11y-frontend", "image": "grafana/docker-puppeteer:1.0.0", "depends_on": ["grafana-server"], "environment": {"GRAFANA_MISC_STATS_API_KEY": {"from_secret": "grafana_misc_stats_api_key"}, "HOST": "grafana-server", "PORT": 3001}, "failure": "ignore", "commands": ["yarn wait-on http://$HOST:$PORT", "pa11y-ci --config .pa11yci.conf.js --json > pa11y-ci-results.json"]}, {"name": "publish-frontend-metrics", "image": "grafana/build-container:1.4.9", "depends_on": ["test-a11y-frontend"], "environment": {"GRAFANA_MISC_STATS_API_KEY": {"from_secret": "grafana_misc_stats_api_key"}}, "failure": "ignore", "commands": ["./scripts/ci-frontend-metrics.sh | ./bin/grabpl publish-metrics $${GRAFANA_MISC_STATS_API_KEY}"]}, {"name": "build-frontend-docs", "image": "grafana/build-container:1.4.9", "depends_on": ["build-frontend"], "commands": ["./scripts/ci-reference-docs-lint.sh ci"]}, {"name": "copy-packages-for-docker", "image": "grafana/build-container:1.4.9", "depends_on": ["package"], "commands": ["ls dist/*.tar.gz*", "cp dist/*.tar.gz* packaging/docker/"]}, {"name": "build-docker-images", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition oss"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}, {"name": "build-docker-images-ubuntu", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition oss --ubuntu"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}, {"name": "publish-images-grafana", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker publish --dockerhub-repo grafana --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7"], "depends_on": ["build-docker-images", "build-docker-images-ubuntu"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "publish-images-grafana-oss", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker publish --dockerhub-repo grafana-oss --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7"], "depends_on": ["build-docker-images", "build-docker-images-ubuntu"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "release-canary-npm-packages", "image": "grafana/build-container:1.4.9", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "environment": {"NPM_TOKEN": {"from_secret": "npm_token"}}, "commands": ["./scripts/circle-release-canary-packages.sh"]}, {"name": "upload-packages", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-packages --edition oss --packages-bucket grafana-downloads"]}, {"name": "upload-cdn-assets", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["grafana-server"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-cdn --edition oss --src-bucket \"grafana-static-assets\""]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-integration-tests", "trigger": {"event": ["push"], "branch": "main"}, "services": [{"name": "postgres", "image": "postgres:12.3-alpine", "environment": {"POSTGRES_USER": "grafanatest", "POSTGRES_PASSWORD": "grafanatest", "POSTGRES_DB": "grafanatest", "PGDATA": "/var/lib/postgresql/data/pgdata"}, "volumes": [{"name": "postgres", "path": "/var/lib/postgresql/data/pgdata"}]}, {"name": "mysql", "image": "mysql:5.6.48", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql", "path": "/var/lib/mysql"}]}], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "postgres-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["grabpl"], "environment": {"PGPASSWORD": "grafanatest", "GRAFANA_TEST_DB": "postgres", "POSTGRES_HOST": "postgres"}, "commands": ["apt-get update", "apt-get install -yq postgresql-client", "dockerize -wait tcp://postgres:5432 -timeout 120s", "psql -p 5432 -h postgres -U grafanatest -d grafanatest -f devenv/docker/blocks/postgres_tests/setup.sql", "go clean -testcache", "./bin/grabpl integration-tests --database postgres"]}, {"name": "mysql-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["grabpl"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql"}, "commands": ["apt-get update", "apt-get install -yq default-mysql-client", "dockerize -wait tcp://mysql:3306 -timeout 120s", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql -P 3306 -u root -prootpass", "go clean -testcache", "./bin/grabpl integration-tests --database mysql"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "windows-main", "trigger": {"event": ["push"], "branch": "main"}, "services": [], "steps": [{"name": "identify-runner", "image": "mcr.microsoft.com/windows:1809", "commands": ["echo $env:DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/ci-wix:0.1.1", "commands": ["$$ProgressPreference = \"SilentlyContinue\"", "Invoke-WebRequest https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/windows/grabpl.exe -OutFile grabpl.exe"]}, {"name": "build-windows-installer", "image": "grafana/ci-wix:0.1.1", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}, "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["$$gcpKey = $$env:GCP_KEY", "[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($$gcpKey)) > gcpkey.json", "dos2unix gcpkey.json", "gcloud auth activate-service-account --key-file=gcpkey.json", "rm gcpkey.json", "cp C:\\App\\nssm-2.24.zip .", ".\\grabpl.exe gen-version --build-id $$env:DRONE_BUILD_NUMBER", ".\\grabpl.exe windows-installer --edition oss --packages-bucket grafana-downloads --build-id $$env:DRONE_BUILD_NUMBER", "$$fname = ((Get-Childitem grafana*.msi -name) -split \"`n\")[0]", "gsutil cp $$fname gs://grafana-downloads/oss/main/", "gsutil cp \"$$fname.sha256\" gs://grafana-downloads/oss/main/"], "depends_on": ["initialize"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["main-test", "main-build-e2e-publish", "main-integration-tests"], "platform": {"os": "windows", "arch": "amd64", "version": "1809"}}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "notify-drone-changes", "trigger": {"event": ["push"], "branch": "main", "paths": {"include": [".drone.yml"], "exclude": ["exclude"]}}, "steps": [{"name": "slack", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "drone-changes-webhook"}, "channel": "slack-webhooks-test", "template": "`.drone.yml` and `starlark` files have been changed on the OSS repo, by: {{build.author}}. \nBranch: \u003chttps://github.com/{{ repo.owner }}/{{ repo.name }}/commits/{{ build.branch }}|{{ build.branch }}\u003e\nCommit hash: \u003chttps://github.com/{{repo.owner}}/{{repo.name}}/commit/{{build.commit}}|{{ truncate build.commit 8 }}\u003e"}}], "depends_on": []}
---
{"kind": "pipeline", "type": "docker", "name": "publish-main", "trigger": {"event": ["push"], "branch": "main"}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go"]}, {"name": "store-packages-oss", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["grabpl"], "environment": {"GRAFANA_COM_API_KEY": {"from_secret": "grafana_api_key"}, "GCP_KEY": {"from_secret": "gcp_key"}, "GPG_PRIV_KEY": {"from_secret": "gpg_priv_key"}, "GPG_PUB_KEY": {"from_secret": "gpg_pub_key"}, "GPG_KEY_PASSWORD": {"from_secret": "gpg_key_password"}}, "commands": ["./bin/grabpl store-packages --edition oss --gcp-key /tmp/gcpkey.json --build-id ${DRONE_BUILD_NUMBER}"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["main-test", "main-build-e2e-publish", "main-integration-tests", "windows-main"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "notify-main", "trigger": {"event": ["push"], "branch": "main", "status": ["failure"]}, "steps": [{"name": "slack", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook"}, "channel": "grafana-ci-notifications", "template": "Build {{build.number}} failed for commit: \u003chttps://github.com/{{repo.owner}}/{{repo.name}}/commit/{{build.commit}}|{{ truncate build.commit 8 }}\u003e: {{build.link}}\nBranch: \u003chttps://github.com/{{ repo.owner }}/{{ repo.name }}/commits/{{ build.branch }}|{{ build.branch }}\u003e\nAuthor: {{build.author}}"}}], "depends_on": ["main-test", "main-build-e2e-publish", "main-integration-tests", "windows-main", "publish-main"]}
---
{"kind": "pipeline", "type": "docker", "name": "oss-build-e2e-publish-release", "trigger": {"event": {"exclude": ["promote"]}, "ref": ["refs/tags/v*"], "repo": {"exclude": ["grafana/grafana"]}}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl verify-version ${DRONE_TAG}", "./bin/grabpl gen-version ${DRONE_TAG}", "yarn install --immutable"]}, {"name": "build-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["./bin/grabpl build-backend --jobs 8 --edition oss --github-token $${GITHUB_TOKEN} --no-pull-enterprise ${DRONE_TAG}"]}, {"name": "build-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "commands": ["./bin/grabpl build-frontend --jobs 8 --github-token $${GITHUB_TOKEN} --no-install-deps --edition oss --no-pull-enterprise ${DRONE_TAG}"]}, {"name": "build-plugins", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}}, "commands": ["./bin/grabpl build-plugins --jobs 8 --edition oss --no-install-deps --sign --signing-admin"]}, {"name": "validate-scuemata", "image": "grafana/build-container:1.4.9", "depends_on": ["build-backend"], "commands": ["./bin/linux-amd64/grafana-cli cue validate-schema --grafana-root ."]}, {"name": "ensure-cuetsified", "image": "grafana/build-container:1.4.9", "depends_on": ["validate-scuemata"], "commands": ["# Make sure the git tree is clean.", "# Stashing changes, since packages that were produced in build-backend step are needed.", "git stash", "./bin/linux-amd64/grafana-cli cue gen-ts --grafana-root .", "# The above command generates Typescript files (*.gen.ts) from all appropriate .cue files.", "# It is required that the generated Typescript be in sync with the input CUE files.", "# ...Modulo eslint auto-fixes...:", "yarn run eslint . --ext .gen.ts --fix", "# If any filenames are emitted by the below script, run the generator command `grafana-cli cue gen-ts` locally and commit the result.", "./scripts/clean-git-or-error.sh", "# Un-stash changes.", "git stash pop"]}, {"name": "package", "image": "grafana/build-container:1.4.9", "depends_on": ["build-plugins", "build-backend", "build-frontend"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "GPG_PRIV_KEY": {"from_secret": "gpg_priv_key"}, "GPG_PUB_KEY": {"from_secret": "gpg_pub_key"}, "GPG_KEY_PASSWORD": {"from_secret": "gpg_key_password"}}, "commands": ["./bin/grabpl package --jobs 8 --edition oss --github-token $${GITHUB_TOKEN} --no-pull-enterprise --sign ${DRONE_TAG}"]}, {"name": "copy-packages-for-docker", "image": "grafana/build-container:1.4.9", "depends_on": ["package"], "commands": ["ls dist/*.tar.gz*", "cp dist/*.tar.gz* packaging/docker/"]}, {"name": "build-docker-images", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition oss --shouldSave"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}, {"name": "build-docker-images-ubuntu", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition oss --shouldSave --ubuntu"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}, {"name": "grafana-server", "image": "grafana/build-container:1.4.9", "detach": true, "depends_on": ["build-plugins", "build-backend", "build-frontend"], "environment": {"PORT": 3001, "ARCH": "linux-amd64"}, "commands": ["./scripts/grafana-server/start-server"]}, {"name": "end-to-end-tests-dashboards-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite dashboards-suite --tries 3"]}, {"name": "end-to-end-tests-smoke-tests-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite smoke-tests-suite --tries 3"]}, {"name": "end-to-end-tests-panels-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite panels-suite --tries 3"]}, {"name": "end-to-end-tests-various-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite various-suite --tries 3"]}, {"name": "e2e-tests-artifacts-upload", "image": "google/cloud-sdk:367.0.0", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "when": {"status": ["success", "failure"]}, "environment": {"GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY": {"from_secret": "gcp_upload_artifacts_key"}, "E2E_TEST_ARTIFACTS_BUCKET": "releng-pipeline-artifacts-dev", "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apt-get update", "apt-get install -yq zip", "ls -lah ./e2e", "find ./e2e -type f -name \"*.mp4\"", "printenv GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY > /tmp/gcpkey_upload_artifacts.json", "gcloud auth activate-service-account --key-file=/tmp/gcpkey_upload_artifacts.json", "find ./e2e -type f -name \"*spec.ts.mp4\" | zip e2e/videos.zip -@", "gsutil cp e2e/videos.zip gs://$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "export E2E_ARTIFACTS_VIDEO_ZIP=https://storage.googleapis.com/$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "echo \"E2E Test artifacts uploaded to: $${E2E_ARTIFACTS_VIDEO_ZIP}\"", "curl -X POST https://api.github.com/repos/${DRONE_REPO}/statuses/${DRONE_COMMIT_SHA} -H \"Authorization: token $${GITHUB_TOKEN}\" -d \"{\\\"state\\\":\\\"success\\\",\\\"target_url\\\":\\\"$${E2E_ARTIFACTS_VIDEO_ZIP}\\\", \\\"description\\\": \\\"Click on the details to download e2e recording videos\\\", \\\"context\\\": \\\"e2e_artifacts\\\"}\""]}, {"name": "build-storybook", "image": "grafana/build-container:1.4.9", "depends_on": ["build-frontend"], "environment": {"NODE_OPTIONS": "--max_old_space_size=4096"}, "commands": ["yarn storybook:build", "./bin/grabpl verify-storybook"]}, {"name": "upload-cdn-assets", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["grafana-server"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-cdn --edition oss --src-bucket \"$${PRERELEASE_BUCKET}\" --src-dir artifacts/static-assets"]}, {"name": "upload-packages", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-packages --edition oss --packages-bucket $${PRERELEASE_BUCKET}/artifacts/downloads"]}, {"name": "store-storybook", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["build-storybook", "end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["printenv GCP_KEY | base64 -d > /tmp/gcpkey.json", "gcloud auth activate-service-account --key-file=/tmp/gcpkey.json", "gsutil -m rsync -d -r ./packages/grafana-ui/dist/storybook gs://$${PRERELEASE_BUCKET}/artifacts/storybook/latest", "gsutil -m rsync -d -r ./packages/grafana-ui/dist/storybook gs://$${PRERELEASE_BUCKET}/artifacts/storybook/${DRONE_TAG}"]}, {"name": "build-npm-packages", "image": "grafana/build-container:1.4.9", "depends_on": ["store-storybook"], "commands": ["./scripts/build/build-npm-packages.sh ${DRONE_TAG}"]}, {"name": "store-npm-packages", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["build-npm-packages"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl artifacts npm store --tag ${DRONE_TAG}"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "oss-test-release", "trigger": {"event": {"exclude": ["promote"]}, "ref": ["refs/tags/v*"], "repo": {"exclude": ["grafana/grafana"]}}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl verify-version ${DRONE_TAG}", "./bin/grabpl gen-version ${DRONE_TAG}", "yarn install --immutable"]}, {"name": "codespell", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["echo -e \"unknwon\nreferer\nerrorstring\neror\niam\nwan\" \u003e words_to_ignore.txt", "codespell -I words_to_ignore.txt docs/", "rm words_to_ignore.txt"]}, {"name": "shellcheck", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl shellcheck"]}, {"name": "lint-backend", "image": "grafana/build-container:1.4.9", "environment": {"CGO_ENABLED": "1"}, "depends_on": ["initialize"], "commands": ["./bin/grabpl lint-backend --edition oss"]}, {"name": "lint-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run prettier:check", "yarn run lint", "yarn run i18n:compile", "yarn run typecheck"]}, {"name": "test-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl test-backend --edition oss"]}, {"name": "test-backend-integration", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl integration-tests --edition oss"]}, {"name": "test-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run ci:test-frontend"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "oss-integration-tests-release", "trigger": {"event": {"exclude": ["promote"]}, "ref": ["refs/tags/v*"], "repo": {"exclude": ["grafana/grafana"]}}, "services": [{"name": "postgres", "image": "postgres:12.3-alpine", "environment": {"POSTGRES_USER": "grafanatest", "POSTGRES_PASSWORD": "grafanatest", "POSTGRES_DB": "grafanatest", "PGDATA": "/var/lib/postgresql/data/pgdata"}, "volumes": [{"name": "postgres", "path": "/var/lib/postgresql/data/pgdata"}]}, {"name": "mysql", "image": "mysql:5.6.48", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql", "path": "/var/lib/mysql"}]}], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl verify-version ${DRONE_TAG}", "./bin/grabpl gen-version ${DRONE_TAG}", "yarn install --immutable"]}, {"name": "postgres-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["grabpl"], "environment": {"PGPASSWORD": "grafanatest", "GRAFANA_TEST_DB": "postgres", "POSTGRES_HOST": "postgres"}, "commands": ["apt-get update", "apt-get install -yq postgresql-client", "dockerize -wait tcp://postgres:5432 -timeout 120s", "psql -p 5432 -h postgres -U grafanatest -d grafanatest -f devenv/docker/blocks/postgres_tests/setup.sql", "go clean -testcache", "./bin/grabpl integration-tests --database postgres"]}, {"name": "mysql-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["grabpl"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql"}, "commands": ["apt-get update", "apt-get install -yq default-mysql-client", "dockerize -wait tcp://mysql:3306 -timeout 120s", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql -P 3306 -u root -prootpass", "go clean -testcache", "./bin/grabpl integration-tests --database mysql"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "oss-windows-release", "trigger": {"event": {"exclude": ["promote"]}, "ref": ["refs/tags/v*"], "repo": {"exclude": ["grafana/grafana"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "mcr.microsoft.com/windows:1809", "commands": ["echo $env:DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/ci-wix:0.1.1", "commands": ["$$ProgressPreference = \"SilentlyContinue\"", "Invoke-WebRequest https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/windows/grabpl.exe -OutFile grabpl.exe"]}, {"name": "build-windows-installer", "image": "grafana/ci-wix:0.1.1", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}, "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["$$gcpKey = $$env:GCP_KEY", "[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($$gcpKey)) > gcpkey.json", "dos2unix gcpkey.json", "gcloud auth activate-service-account --key-file=gcpkey.json", "rm gcpkey.json", "cp C:\\App\\nssm-2.24.zip .", ".\\grabpl.exe gen-version ${DRONE_TAG}", ".\\grabpl.exe windows-installer --edition oss ${DRONE_TAG}", "$$fname = ((Get-Childitem grafana*.msi -name) -split \"`n\")[0]", "gsutil cp $$fname gs://%PRERELEASE_BUCKET%/artifacts/downloads/${DRONE_TAG}/oss/release/", "gsutil cp \"$$fname.sha256\" gs://%PRERELEASE_BUCKET%/artifacts/downloads/${DRONE_TAG}/oss/release/"], "depends_on": ["initialize"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["oss-build-e2e-publish-release", "oss-test-release", "oss-integration-tests-release"], "platform": {"os": "windows", "arch": "amd64", "version": "1809"}}
---
{"kind": "pipeline", "type": "docker", "name": "enterprise-build-e2e-publish-release", "trigger": {"event": {"exclude": ["promote"]}, "ref": ["refs/tags/v*"], "repo": {"exclude": ["grafana/grafana"]}}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "clone-enterprise", "image": "grafana/build-container:1.4.9", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\"", "cd grafana-enterprise", "git checkout ${DRONE_TAG}"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "depends_on": ["clone-enterprise"], "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["mv bin/grabpl /tmp/", "rmdir bin", "mv grafana-enterprise /tmp/", "/tmp/grabpl init-enterprise --github-token $${GITHUB_TOKEN} /tmp/grafana-enterprise ${DRONE_TAG}", "mv /tmp/grafana-enterprise/deployment_tools_config.json deployment_tools_config.json", "mkdir bin", "mv /tmp/grabpl bin/", "make gen-go", "./bin/grabpl verify-version ${DRONE_TAG}", "./bin/grabpl gen-version ${DRONE_TAG}", "yarn install --immutable"]}, {"name": "build-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["./bin/grabpl build-backend --jobs 8 --edition enterprise --github-token $${GITHUB_TOKEN} --no-pull-enterprise ${DRONE_TAG}"]}, {"name": "build-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "commands": ["./bin/grabpl build-frontend --jobs 8 --github-token $${GITHUB_TOKEN} --no-install-deps --edition enterprise --no-pull-enterprise ${DRONE_TAG}"]}, {"name": "build-plugins", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}}, "commands": ["./bin/grabpl build-plugins --jobs 8 --edition enterprise --no-install-deps --sign --signing-admin"]}, {"name": "validate-scuemata", "image": "grafana/build-container:1.4.9", "depends_on": ["build-backend"], "commands": ["./bin/linux-amd64/grafana-cli cue validate-schema --grafana-root ."]}, {"name": "ensure-cuetsified", "image": "grafana/build-container:1.4.9", "depends_on": ["validate-scuemata"], "commands": ["# Make sure the git tree is clean.", "# Stashing changes, since packages that were produced in build-backend step are needed.", "git stash", "./bin/linux-amd64/grafana-cli cue gen-ts --grafana-root .", "# The above command generates Typescript files (*.gen.ts) from all appropriate .cue files.", "# It is required that the generated Typescript be in sync with the input CUE files.", "# ...Modulo eslint auto-fixes...:", "yarn run eslint . --ext .gen.ts --fix", "# If any filenames are emitted by the below script, run the generator command `grafana-cli cue gen-ts` locally and commit the result.", "./scripts/clean-git-or-error.sh", "# Un-stash changes.", "git stash pop"]}, {"name": "build-backend-enterprise2", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["./bin/grabpl build-backend --jobs 8 --edition enterprise2 --github-token $${GITHUB_TOKEN} --no-pull-enterprise ${DRONE_TAG}"]}, {"name": "package", "image": "grafana/build-container:1.4.9", "depends_on": ["build-plugins", "build-backend", "build-frontend", "build-backend-enterprise2"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "GPG_PRIV_KEY": {"from_secret": "gpg_priv_key"}, "GPG_PUB_KEY": {"from_secret": "gpg_pub_key"}, "GPG_KEY_PASSWORD": {"from_secret": "gpg_key_password"}}, "commands": ["./bin/grabpl package --jobs 8 --edition enterprise --github-token $${GITHUB_TOKEN} --no-pull-enterprise --sign ${DRONE_TAG}"]}, {"name": "copy-packages-for-docker", "image": "grafana/build-container:1.4.9", "depends_on": ["package"], "commands": ["ls dist/*.tar.gz*", "cp dist/*.tar.gz* packaging/docker/"]}, {"name": "build-docker-images", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition enterprise --shouldSave"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}, {"name": "build-docker-images-ubuntu", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition enterprise --shouldSave --ubuntu"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}, {"name": "grafana-server", "image": "grafana/build-container:1.4.9", "detach": true, "depends_on": ["build-plugins", "build-backend", "build-frontend"], "environment": {"PORT": 3001, "ARCH": "linux-amd64", "RUNDIR": "scripts/grafana-server/tmp-grafana-enterprise"}, "commands": ["./scripts/grafana-server/start-server"]}, {"name": "end-to-end-tests-dashboards-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite dashboards-suite --tries 3"]}, {"name": "end-to-end-tests-smoke-tests-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite smoke-tests-suite --tries 3"]}, {"name": "end-to-end-tests-panels-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite panels-suite --tries 3"]}, {"name": "end-to-end-tests-various-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite various-suite --tries 3"]}, {"name": "e2e-tests-artifacts-upload", "image": "google/cloud-sdk:367.0.0", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "when": {"status": ["success", "failure"]}, "environment": {"GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY": {"from_secret": "gcp_upload_artifacts_key"}, "E2E_TEST_ARTIFACTS_BUCKET": "releng-pipeline-artifacts-dev", "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apt-get update", "apt-get install -yq zip", "ls -lah ./e2e", "find ./e2e -type f -name \"*.mp4\"", "printenv GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY > /tmp/gcpkey_upload_artifacts.json", "gcloud auth activate-service-account --key-file=/tmp/gcpkey_upload_artifacts.json", "find ./e2e -type f -name \"*spec.ts.mp4\" | zip e2e/videos.zip -@", "gsutil cp e2e/videos.zip gs://$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "export E2E_ARTIFACTS_VIDEO_ZIP=https://storage.googleapis.com/$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "echo \"E2E Test artifacts uploaded to: $${E2E_ARTIFACTS_VIDEO_ZIP}\"", "curl -X POST https://api.github.com/repos/${DRONE_REPO}/statuses/${DRONE_COMMIT_SHA} -H \"Authorization: token $${GITHUB_TOKEN}\" -d \"{\\\"state\\\":\\\"success\\\",\\\"target_url\\\":\\\"$${E2E_ARTIFACTS_VIDEO_ZIP}\\\", \\\"description\\\": \\\"Click on the details to download e2e recording videos\\\", \\\"context\\\": \\\"e2e_artifacts\\\"}\""]}, {"name": "upload-cdn-assets", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["package"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-cdn --edition enterprise --src-bucket \"$${PRERELEASE_BUCKET}\" --src-dir artifacts/static-assets"]}, {"name": "upload-packages", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["package"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-packages --edition enterprise --packages-bucket $${PRERELEASE_BUCKET}/artifacts/downloads"]}, {"name": "package-enterprise2", "image": "grafana/build-container:1.4.9", "depends_on": ["build-plugins", "build-backend", "build-frontend", "build-backend-enterprise2"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "GPG_PRIV_KEY": {"from_secret": "gpg_priv_key"}, "GPG_PUB_KEY": {"from_secret": "gpg_pub_key"}, "GPG_KEY_PASSWORD": {"from_secret": "gpg_key_password"}}, "commands": ["./bin/grabpl package --jobs 8 --edition enterprise2 --github-token $${GITHUB_TOKEN} --no-pull-enterprise --sign ${DRONE_TAG}"]}, {"name": "upload-cdn-assets-enterprise2", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["package-enterprise2"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-cdn --edition enterprise2 --src-bucket \"$${PRERELEASE_BUCKET}\" --src-dir artifacts/static-assets"]}, {"name": "upload-packages-enterprise2", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["package-enterprise2"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-packages --edition enterprise2 --packages-bucket $${PRERELEASE_BUCKET}/artifacts/downloads-enterprise2"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}, "image_pull_secrets": ["dockerconfigjson"], "clone": {"disable": true}}
---
{"kind": "pipeline", "type": "docker", "name": "enterprise-test-release", "trigger": {"event": {"exclude": ["promote"]}, "ref": ["refs/tags/v*"], "repo": {"exclude": ["grafana/grafana"]}}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "clone-enterprise", "image": "grafana/build-container:1.4.9", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\"", "cd grafana-enterprise", "git checkout ${DRONE_TAG}"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "depends_on": ["clone-enterprise"], "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["mv bin/grabpl /tmp/", "rmdir bin", "mv grafana-enterprise /tmp/", "/tmp/grabpl init-enterprise --github-token $${GITHUB_TOKEN} /tmp/grafana-enterprise ${DRONE_TAG}", "mv /tmp/grafana-enterprise/deployment_tools_config.json deployment_tools_config.json", "mkdir bin", "mv /tmp/grabpl bin/", "make gen-go", "./bin/grabpl verify-version ${DRONE_TAG}", "./bin/grabpl gen-version ${DRONE_TAG}", "yarn install --immutable"]}, {"name": "codespell", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["echo -e \"unknwon\nreferer\nerrorstring\neror\niam\nwan\" \u003e words_to_ignore.txt", "codespell -I words_to_ignore.txt docs/", "rm words_to_ignore.txt"]}, {"name": "shellcheck", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl shellcheck"]}, {"name": "lint-backend", "image": "grafana/build-container:1.4.9", "environment": {"CGO_ENABLED": "1"}, "depends_on": ["initialize"], "commands": ["./bin/grabpl lint-backend --edition enterprise"]}, {"name": "lint-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run prettier:check", "yarn run lint", "yarn run i18n:compile", "yarn run typecheck"]}, {"name": "test-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl test-backend --edition enterprise"]}, {"name": "test-backend-integration", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl integration-tests --edition enterprise"]}, {"name": "test-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run ci:test-frontend"]}, {"name": "lint-backend-enterprise2", "image": "grafana/build-container:1.4.9", "environment": {"CGO_ENABLED": "1"}, "depends_on": ["initialize"], "commands": ["./bin/grabpl lint-backend --edition enterprise2"]}, {"name": "test-backend-enterprise2", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl test-backend --edition enterprise2"]}, {"name": "test-backend-integration-enterprise2", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl integration-tests --edition enterprise2"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}, "image_pull_secrets": ["dockerconfigjson"], "clone": {"disable": true}}
---
{"kind": "pipeline", "type": "docker", "name": "enterprise-integration-tests-release", "trigger": {"event": {"exclude": ["promote"]}, "ref": ["refs/tags/v*"], "repo": {"exclude": ["grafana/grafana"]}}, "services": [{"name": "postgres", "image": "postgres:12.3-alpine", "environment": {"POSTGRES_USER": "grafanatest", "POSTGRES_PASSWORD": "grafanatest", "POSTGRES_DB": "grafanatest", "PGDATA": "/var/lib/postgresql/data/pgdata"}, "volumes": [{"name": "postgres", "path": "/var/lib/postgresql/data/pgdata"}]}, {"name": "mysql", "image": "mysql:5.6.48", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql", "path": "/var/lib/mysql"}]}, {"name": "redis", "image": "redis:6.2.1-alpine", "environment": {}}, {"name": "memcached", "image": "memcached:1.6.9-alpine", "environment": {}}], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "clone-enterprise", "image": "grafana/build-container:1.4.9", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\"", "cd grafana-enterprise", "git checkout ${DRONE_TAG}"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "depends_on": ["clone-enterprise"], "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["mv bin/grabpl /tmp/", "rmdir bin", "mv grafana-enterprise /tmp/", "/tmp/grabpl init-enterprise --github-token $${GITHUB_TOKEN} /tmp/grafana-enterprise ${DRONE_TAG}", "mv /tmp/grafana-enterprise/deployment_tools_config.json deployment_tools_config.json", "mkdir bin", "mv /tmp/grabpl bin/", "make gen-go", "./bin/grabpl verify-version ${DRONE_TAG}", "./bin/grabpl gen-version ${DRONE_TAG}", "yarn install --immutable"]}, {"name": "postgres-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"PGPASSWORD": "grafanatest", "GRAFANA_TEST_DB": "postgres", "POSTGRES_HOST": "postgres"}, "commands": ["apt-get update", "apt-get install -yq postgresql-client", "dockerize -wait tcp://postgres:5432 -timeout 120s", "psql -p 5432 -h postgres -U grafanatest -d grafanatest -f devenv/docker/blocks/postgres_tests/setup.sql", "go clean -testcache", "./bin/grabpl integration-tests --database postgres"]}, {"name": "mysql-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql"}, "commands": ["apt-get update", "apt-get install -yq default-mysql-client", "dockerize -wait tcp://mysql:3306 -timeout 120s", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql -P 3306 -u root -prootpass", "go clean -testcache", "./bin/grabpl integration-tests --database mysql"]}, {"name": "redis-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"REDIS_URL": "redis://redis:6379/0"}, "commands": ["dockerize -wait tcp://redis:6379/0 -timeout 120s", "./bin/grabpl integration-tests"]}, {"name": "memcached-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"MEMCACHED_HOSTS": "memcached:11211"}, "commands": ["dockerize -wait tcp://memcached:11211 -timeout 120s", "./bin/grabpl integration-tests"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}, "image_pull_secrets": ["dockerconfigjson"], "clone": {"disable": true}}
---
{"kind": "pipeline", "type": "docker", "name": "enterprise-windows-release", "trigger": {"event": {"exclude": ["promote"]}, "ref": ["refs/tags/v*"], "repo": {"exclude": ["grafana/grafana"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "mcr.microsoft.com/windows:1809", "commands": ["echo $env:DRONE_RUNNER_NAME"]}, {"name": "clone", "image": "grafana/ci-wix:0.1.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["$$ProgressPreference = \"SilentlyContinue\"", "Invoke-WebRequest https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/windows/grabpl.exe -OutFile grabpl.exe", "git clone \"https://$$env:GITHUB_TOKEN@github.com/grafana/grafana-enterprise.git\"", "cd grafana-enterprise", "git checkout ${DRONE_TAG}"]}, {"name": "initialize", "image": "grafana/ci-wix:0.1.1", "commands": ["cp -r grafana-enterprise C:\\App\\grafana-enterprise", "rm -r -force grafana-enterprise", "cp grabpl.exe C:\\App\\grabpl.exe", "rm -force grabpl.exe", "C:\\App\\grabpl.exe init-enterprise --github-token $$env:GITHUB_TOKEN C:\\App\\grafana-enterprise", "cp C:\\App\\grabpl.exe grabpl.exe"], "depends_on": ["clone"], "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}}, {"name": "build-windows-installer", "image": "grafana/ci-wix:0.1.1", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}, "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["$$gcpKey = $$env:GCP_KEY", "[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($$gcpKey)) > gcpkey.json", "dos2unix gcpkey.json", "gcloud auth activate-service-account --key-file=gcpkey.json", "rm gcpkey.json", "cp C:\\App\\nssm-2.24.zip .", ".\\grabpl.exe gen-version ${DRONE_TAG}", ".\\grabpl.exe windows-installer --edition enterprise ${DRONE_TAG}", "$$fname = ((Get-Childitem grafana*.msi -name) -split \"`n\")[0]", "gsutil cp $$fname gs://%PRERELEASE_BUCKET%/artifacts/downloads/${DRONE_TAG}/enterprise/release/", "gsutil cp \"$$fname.sha256\" gs://%PRERELEASE_BUCKET%/artifacts/downloads/${DRONE_TAG}/enterprise/release/"], "depends_on": ["initialize"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["enterprise-build-e2e-publish-release", "enterprise-test-release", "enterprise-integration-tests-release"], "platform": {"os": "windows", "arch": "amd64", "version": "1809"}, "image_pull_secrets": ["dockerconfigjson"], "clone": {"disable": true}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-docker-oss-public", "trigger": {"event": ["promote"], "target": ["public"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "fetch-images-oss", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker fetch --version-tag ${TAG} --edition oss --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7"], "depends_on": ["grabpl"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "publish-images-grafana", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker publish --dockerhub-repo grafana --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7 --version-tag ${TAG}"], "depends_on": ["fetch-images-oss"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "publish-images-grafana-oss", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker publish --dockerhub-repo grafana-oss --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7 --version-tag ${TAG}"], "depends_on": ["fetch-images-oss"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-docker-enterprise-public", "trigger": {"event": ["promote"], "target": ["public"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "fetch-images-enterprise", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker fetch --version-tag ${TAG} --edition enterprise --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7"], "depends_on": ["grabpl"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "publish-images-grafana-enterprise", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker publish --dockerhub-repo grafana-enterprise --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7 --version-tag ${TAG}"], "depends_on": ["fetch-images-enterprise"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-docker-oss-security", "trigger": {"event": ["promote"], "target": ["security"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "fetch-images-oss", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker fetch --version-tag ${TAG} --edition oss --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7"], "depends_on": ["grabpl"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "publish-images-grafana", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker publish --security --dockerhub-repo grafana --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7 --version-tag ${TAG}"], "depends_on": ["fetch-images-oss"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "publish-images-grafana-oss", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker publish --security --dockerhub-repo grafana-oss --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7 --version-tag ${TAG}"], "depends_on": ["fetch-images-oss"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-docker-enterprise-security", "trigger": {"event": ["promote"], "target": ["security"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "fetch-images-enterprise", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker fetch --version-tag ${TAG} --edition enterprise --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7"], "depends_on": ["grabpl"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "publish-images-grafana-enterprise", "image": "google/cloud-sdk", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/grabpl artifacts docker publish --security --dockerhub-repo grafana-enterprise --base alpine --base ubuntu --arch amd64 --arch arm64 --arch armv7 --version-tag ${TAG}"], "depends_on": ["fetch-images-enterprise"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-artifacts-security", "trigger": {"event": ["promote"], "target": ["security"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "publish-artifacts", "image": "grafana/grafana-ci-deploy:1.3.1", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}, "commands": ["./bin/grabpl artifacts publish --security --tag ${TAG} --src-bucket grafana-prerelease"], "depends_on": ["grabpl"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-artifacts-public", "trigger": {"event": ["promote"], "target": ["public"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "publish-artifacts", "image": "grafana/grafana-ci-deploy:1.3.1", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}, "commands": ["./bin/grabpl artifacts publish --tag ${TAG} --src-bucket grafana-prerelease"], "depends_on": ["grabpl"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-npm-packages-public", "trigger": {"event": ["promote"], "target": ["public"]}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl verify-version ${DRONE_TAG}", "./bin/grabpl gen-version ${DRONE_TAG}", "yarn install --immutable"]}, {"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "retrieve-npm-packages", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["initialize"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl artifacts npm retrieve --tag v${TAG}"]}, {"name": "release-npm-packages", "image": "grafana/build-container:1.4.9", "depends_on": ["retrieve-npm-packages"], "environment": {"NPM_TOKEN": {"from_secret": "npm_token"}}, "commands": ["./bin/grabpl artifacts npm release --tag v${TAG}"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-packages", "trigger": {"event": ["promote"], "target": ["public"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "store-packages-oss", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["grabpl"], "environment": {"GRAFANA_COM_API_KEY": {"from_secret": "grafana_api_key"}, "GCP_KEY": {"from_secret": "gcp_key"}, "GPG_PRIV_KEY": {"from_secret": "gpg_priv_key"}, "GPG_PUB_KEY": {"from_secret": "gpg_pub_key"}, "GPG_KEY_PASSWORD": {"from_secret": "gpg_key_password"}}, "commands": ["./bin/grabpl store-packages --edition oss --packages-bucket grafana-downloads --gcp-key /tmp/gcpkey.json ${DRONE_TAG}"]}, {"name": "store-packages-enterprise", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["grabpl"], "environment": {"GRAFANA_COM_API_KEY": {"from_secret": "grafana_api_key"}, "GCP_KEY": {"from_secret": "gcp_key"}, "GPG_PRIV_KEY": {"from_secret": "gpg_priv_key"}, "GPG_PUB_KEY": {"from_secret": "gpg_pub_key"}, "GPG_KEY_PASSWORD": {"from_secret": "gpg_key_password"}}, "commands": ["./bin/grabpl store-packages --edition enterprise --packages-bucket grafana-downloads --gcp-key /tmp/gcpkey.json ${DRONE_TAG}"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["publish-artifacts-public"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "oss-build-e2e-publish-release-branch", "trigger": {"ref": ["refs/heads/v[0-9]*"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "build-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {}, "commands": ["./bin/grabpl build-backend --jobs 8 --edition oss --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise"]}, {"name": "build-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "commands": ["./bin/grabpl build-frontend --jobs 8 --no-install-deps --edition oss --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise"]}, {"name": "build-plugins", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}}, "commands": ["./bin/grabpl build-plugins --jobs 8 --edition oss --no-install-deps --sign --signing-admin"]}, {"name": "validate-scuemata", "image": "grafana/build-container:1.4.9", "depends_on": ["build-backend"], "commands": ["./bin/linux-amd64/grafana-cli cue validate-schema --grafana-root ."]}, {"name": "ensure-cuetsified", "image": "grafana/build-container:1.4.9", "depends_on": ["validate-scuemata"], "commands": ["# Make sure the git tree is clean.", "# Stashing changes, since packages that were produced in build-backend step are needed.", "git stash", "./bin/linux-amd64/grafana-cli cue gen-ts --grafana-root .", "# The above command generates Typescript files (*.gen.ts) from all appropriate .cue files.", "# It is required that the generated Typescript be in sync with the input CUE files.", "# ...Modulo eslint auto-fixes...:", "yarn run eslint . --ext .gen.ts --fix", "# If any filenames are emitted by the below script, run the generator command `grafana-cli cue gen-ts` locally and commit the result.", "./scripts/clean-git-or-error.sh", "# Un-stash changes.", "git stash pop"]}, {"name": "package", "image": "grafana/build-container:1.4.9", "depends_on": ["build-plugins", "build-backend", "build-frontend"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "GPG_PRIV_KEY": {"from_secret": "gpg_priv_key"}, "GPG_PUB_KEY": {"from_secret": "gpg_pub_key"}, "GPG_KEY_PASSWORD": {"from_secret": "gpg_key_password"}}, "commands": ["./bin/grabpl package --jobs 8 --edition oss --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise --sign"]}, {"name": "copy-packages-for-docker", "image": "grafana/build-container:1.4.9", "depends_on": ["package"], "commands": ["ls dist/*.tar.gz*", "cp dist/*.tar.gz* packaging/docker/"]}, {"name": "build-docker-images", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition oss --shouldSave"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}, {"name": "build-docker-images-ubuntu", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition oss --shouldSave --ubuntu"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}, {"name": "grafana-server", "image": "grafana/build-container:1.4.9", "detach": true, "depends_on": ["build-plugins", "build-backend", "build-frontend"], "environment": {"PORT": 3001, "ARCH": "linux-amd64"}, "commands": ["./scripts/grafana-server/start-server"]}, {"name": "end-to-end-tests-dashboards-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite dashboards-suite --tries 3"]}, {"name": "end-to-end-tests-smoke-tests-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite smoke-tests-suite --tries 3"]}, {"name": "end-to-end-tests-panels-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite panels-suite --tries 3"]}, {"name": "end-to-end-tests-various-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite various-suite --tries 3"]}, {"name": "e2e-tests-artifacts-upload", "image": "google/cloud-sdk:367.0.0", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "when": {"status": ["success", "failure"]}, "environment": {"GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY": {"from_secret": "gcp_upload_artifacts_key"}, "E2E_TEST_ARTIFACTS_BUCKET": "releng-pipeline-artifacts-dev", "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apt-get update", "apt-get install -yq zip", "ls -lah ./e2e", "find ./e2e -type f -name \"*.mp4\"", "printenv GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY > /tmp/gcpkey_upload_artifacts.json", "gcloud auth activate-service-account --key-file=/tmp/gcpkey_upload_artifacts.json", "find ./e2e -type f -name \"*spec.ts.mp4\" | zip e2e/videos.zip -@", "gsutil cp e2e/videos.zip gs://$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "export E2E_ARTIFACTS_VIDEO_ZIP=https://storage.googleapis.com/$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "echo \"E2E Test artifacts uploaded to: $${E2E_ARTIFACTS_VIDEO_ZIP}\"", "curl -X POST https://api.github.com/repos/${DRONE_REPO}/statuses/${DRONE_COMMIT_SHA} -H \"Authorization: token $${GITHUB_TOKEN}\" -d \"{\\\"state\\\":\\\"success\\\",\\\"target_url\\\":\\\"$${E2E_ARTIFACTS_VIDEO_ZIP}\\\", \\\"description\\\": \\\"Click on the details to download e2e recording videos\\\", \\\"context\\\": \\\"e2e_artifacts\\\"}\""]}, {"name": "build-storybook", "image": "grafana/build-container:1.4.9", "depends_on": ["build-frontend"], "environment": {"NODE_OPTIONS": "--max_old_space_size=4096"}, "commands": ["yarn storybook:build", "./bin/grabpl verify-storybook"]}, {"name": "upload-cdn-assets", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["grafana-server"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-cdn --edition oss --src-bucket \"grafana-static-assets\""]}, {"name": "upload-packages", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-packages --edition oss --packages-bucket grafana-downloads"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "oss-test-release-branch", "trigger": {"ref": ["refs/heads/v[0-9]*"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "codespell", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["echo -e \"unknwon\nreferer\nerrorstring\neror\niam\nwan\" \u003e words_to_ignore.txt", "codespell -I words_to_ignore.txt docs/", "rm words_to_ignore.txt"]}, {"name": "shellcheck", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl shellcheck"]}, {"name": "lint-backend", "image": "grafana/build-container:1.4.9", "environment": {"CGO_ENABLED": "1"}, "depends_on": ["initialize"], "commands": ["./bin/grabpl lint-backend --edition oss"]}, {"name": "lint-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run prettier:check", "yarn run lint", "yarn run i18n:compile", "yarn run typecheck"]}, {"name": "test-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl test-backend --edition oss"]}, {"name": "test-backend-integration", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl integration-tests --edition oss"]}, {"name": "test-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run ci:test-frontend"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "oss-integration-tests-release-branch", "trigger": {"ref": ["refs/heads/v[0-9]*"]}, "services": [{"name": "postgres", "image": "postgres:12.3-alpine", "environment": {"POSTGRES_USER": "grafanatest", "POSTGRES_PASSWORD": "grafanatest", "POSTGRES_DB": "grafanatest", "PGDATA": "/var/lib/postgresql/data/pgdata"}, "volumes": [{"name": "postgres", "path": "/var/lib/postgresql/data/pgdata"}]}, {"name": "mysql", "image": "mysql:5.6.48", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql", "path": "/var/lib/mysql"}]}], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "commands": ["make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "postgres-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["grabpl"], "environment": {"PGPASSWORD": "grafanatest", "GRAFANA_TEST_DB": "postgres", "POSTGRES_HOST": "postgres"}, "commands": ["apt-get update", "apt-get install -yq postgresql-client", "dockerize -wait tcp://postgres:5432 -timeout 120s", "psql -p 5432 -h postgres -U grafanatest -d grafanatest -f devenv/docker/blocks/postgres_tests/setup.sql", "go clean -testcache", "./bin/grabpl integration-tests --database postgres"]}, {"name": "mysql-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["grabpl"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql"}, "commands": ["apt-get update", "apt-get install -yq default-mysql-client", "dockerize -wait tcp://mysql:3306 -timeout 120s", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql -P 3306 -u root -prootpass", "go clean -testcache", "./bin/grabpl integration-tests --database mysql"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "oss-windows-release-branch", "trigger": {"ref": ["refs/heads/v[0-9]*"]}, "services": [], "steps": [{"name": "identify-runner", "image": "mcr.microsoft.com/windows:1809", "commands": ["echo $env:DRONE_RUNNER_NAME"]}, {"name": "initialize", "image": "grafana/ci-wix:0.1.1", "commands": ["$$ProgressPreference = \"SilentlyContinue\"", "Invoke-WebRequest https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/windows/grabpl.exe -OutFile grabpl.exe"]}, {"name": "build-windows-installer", "image": "grafana/ci-wix:0.1.1", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}, "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["$$gcpKey = $$env:GCP_KEY", "[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($$gcpKey)) > gcpkey.json", "dos2unix gcpkey.json", "gcloud auth activate-service-account --key-file=gcpkey.json", "rm gcpkey.json", "cp C:\\App\\nssm-2.24.zip ."], "depends_on": ["initialize"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["oss-build-e2e-publish-release-branch", "oss-test-release-branch", "oss-integration-tests-release-branch"], "platform": {"os": "windows", "arch": "amd64", "version": "1809"}}
---
{"kind": "pipeline", "type": "docker", "name": "enterprise-build-e2e-publish-release-branch", "trigger": {"ref": ["refs/heads/v[0-9]*"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "clone-enterprise", "image": "grafana/build-container:1.4.9", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\"", "cd grafana-enterprise", "git checkout ${DRONE_BRANCH}"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "depends_on": ["clone-enterprise"], "environment": {}, "commands": ["mv bin/grabpl /tmp/", "rmdir bin", "mv grafana-enterprise /tmp/", "/tmp/grabpl init-enterprise  /tmp/grafana-enterprise", "mv /tmp/grafana-enterprise/deployment_tools_config.json deployment_tools_config.json", "mkdir bin", "mv /tmp/grabpl bin/", "make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "build-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {}, "commands": ["./bin/grabpl build-backend --jobs 8 --edition enterprise --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise"]}, {"name": "build-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "commands": ["./bin/grabpl build-frontend --jobs 8 --no-install-deps --edition enterprise --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise"]}, {"name": "build-plugins", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}}, "commands": ["./bin/grabpl build-plugins --jobs 8 --edition enterprise --no-install-deps --sign --signing-admin"]}, {"name": "validate-scuemata", "image": "grafana/build-container:1.4.9", "depends_on": ["build-backend"], "commands": ["./bin/linux-amd64/grafana-cli cue validate-schema --grafana-root ."]}, {"name": "ensure-cuetsified", "image": "grafana/build-container:1.4.9", "depends_on": ["validate-scuemata"], "commands": ["# Make sure the git tree is clean.", "# Stashing changes, since packages that were produced in build-backend step are needed.", "git stash", "./bin/linux-amd64/grafana-cli cue gen-ts --grafana-root .", "# The above command generates Typescript files (*.gen.ts) from all appropriate .cue files.", "# It is required that the generated Typescript be in sync with the input CUE files.", "# ...Modulo eslint auto-fixes...:", "yarn run eslint . --ext .gen.ts --fix", "# If any filenames are emitted by the below script, run the generator command `grafana-cli cue gen-ts` locally and commit the result.", "./scripts/clean-git-or-error.sh", "# Un-stash changes.", "git stash pop"]}, {"name": "build-backend-enterprise2", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {}, "commands": ["./bin/grabpl build-backend --jobs 8 --edition enterprise2 --build-id ${DRONE_BUILD_NUMBER} --variants linux-x64 --no-pull-enterprise"]}, {"name": "package", "image": "grafana/build-container:1.4.9", "depends_on": ["build-plugins", "build-backend", "build-frontend", "build-backend-enterprise2"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "GPG_PRIV_KEY": {"from_secret": "gpg_priv_key"}, "GPG_PUB_KEY": {"from_secret": "gpg_pub_key"}, "GPG_KEY_PASSWORD": {"from_secret": "gpg_key_password"}}, "commands": ["./bin/grabpl package --jobs 8 --edition enterprise --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise --sign"]}, {"name": "copy-packages-for-docker", "image": "grafana/build-container:1.4.9", "depends_on": ["package"], "commands": ["ls dist/*.tar.gz*", "cp dist/*.tar.gz* packaging/docker/"]}, {"name": "build-docker-images", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition enterprise --shouldSave"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}, {"name": "build-docker-images-ubuntu", "image": "google/cloud-sdk", "depends_on": ["copy-packages-for-docker"], "commands": ["./bin/grabpl build-docker --edition enterprise --shouldSave --ubuntu"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}}}, {"name": "grafana-server", "image": "grafana/build-container:1.4.9", "detach": true, "depends_on": ["build-plugins", "build-backend", "build-frontend"], "environment": {"PORT": 3001, "ARCH": "linux-amd64", "RUNDIR": "scripts/grafana-server/tmp-grafana-enterprise"}, "commands": ["./scripts/grafana-server/start-server"]}, {"name": "end-to-end-tests-dashboards-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite dashboards-suite --tries 3"]}, {"name": "end-to-end-tests-smoke-tests-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite smoke-tests-suite --tries 3"]}, {"name": "end-to-end-tests-panels-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite panels-suite --tries 3"]}, {"name": "end-to-end-tests-various-suite", "image": "cypress/included:9.3.1", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["apt-get install -y netcat", "./bin/grabpl e2e-tests --port 3001 --suite various-suite --tries 3"]}, {"name": "e2e-tests-artifacts-upload", "image": "google/cloud-sdk:367.0.0", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "when": {"status": ["success", "failure"]}, "environment": {"GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY": {"from_secret": "gcp_upload_artifacts_key"}, "E2E_TEST_ARTIFACTS_BUCKET": "releng-pipeline-artifacts-dev", "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apt-get update", "apt-get install -yq zip", "ls -lah ./e2e", "find ./e2e -type f -name \"*.mp4\"", "printenv GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY > /tmp/gcpkey_upload_artifacts.json", "gcloud auth activate-service-account --key-file=/tmp/gcpkey_upload_artifacts.json", "find ./e2e -type f -name \"*spec.ts.mp4\" | zip e2e/videos.zip -@", "gsutil cp e2e/videos.zip gs://$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "export E2E_ARTIFACTS_VIDEO_ZIP=https://storage.googleapis.com/$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "echo \"E2E Test artifacts uploaded to: $${E2E_ARTIFACTS_VIDEO_ZIP}\"", "curl -X POST https://api.github.com/repos/${DRONE_REPO}/statuses/${DRONE_COMMIT_SHA} -H \"Authorization: token $${GITHUB_TOKEN}\" -d \"{\\\"state\\\":\\\"success\\\",\\\"target_url\\\":\\\"$${E2E_ARTIFACTS_VIDEO_ZIP}\\\", \\\"description\\\": \\\"Click on the details to download e2e recording videos\\\", \\\"context\\\": \\\"e2e_artifacts\\\"}\""]}, {"name": "build-storybook", "image": "grafana/build-container:1.4.9", "depends_on": ["build-frontend"], "environment": {"NODE_OPTIONS": "--max_old_space_size=4096"}, "commands": ["yarn storybook:build", "./bin/grabpl verify-storybook"]}, {"name": "upload-cdn-assets", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["package"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-cdn --edition enterprise --src-bucket \"grafana-static-assets\""]}, {"name": "upload-packages", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["package"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-packages --edition enterprise --packages-bucket grafana-downloads"]}, {"name": "package-enterprise2", "image": "grafana/build-container:1.4.9", "depends_on": ["build-plugins", "build-backend", "build-frontend", "build-backend-enterprise2"], "environment": {"GRAFANA_API_KEY": {"from_secret": "grafana_api_key"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "GPG_PRIV_KEY": {"from_secret": "gpg_priv_key"}, "GPG_PUB_KEY": {"from_secret": "gpg_pub_key"}, "GPG_KEY_PASSWORD": {"from_secret": "gpg_key_password"}}, "commands": ["./bin/grabpl package --jobs 8 --edition enterprise2 --build-id ${DRONE_BUILD_NUMBER} --no-pull-enterprise --variants linux-x64 --sign"]}, {"name": "upload-cdn-assets-enterprise2", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["package-enterprise2"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-cdn --edition enterprise2 --src-bucket \"grafana-static-assets\""]}, {"name": "upload-packages-enterprise2", "image": "grafana/grafana-ci-deploy:1.3.1", "depends_on": ["package-enterprise2"], "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/grabpl upload-packages --edition enterprise2 --packages-bucket grafana-downloads-enterprise2"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}, "image_pull_secrets": ["dockerconfigjson"], "clone": {"disable": true}}
---
{"kind": "pipeline", "type": "docker", "name": "enterprise-test-release-branch", "trigger": {"ref": ["refs/heads/v[0-9]*"]}, "services": [], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "clone-enterprise", "image": "grafana/build-container:1.4.9", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\"", "cd grafana-enterprise", "git checkout ${DRONE_BRANCH}"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "depends_on": ["clone-enterprise"], "environment": {}, "commands": ["mv bin/grabpl /tmp/", "rmdir bin", "mv grafana-enterprise /tmp/", "/tmp/grabpl init-enterprise  /tmp/grafana-enterprise", "mv /tmp/grafana-enterprise/deployment_tools_config.json deployment_tools_config.json", "mkdir bin", "mv /tmp/grabpl bin/", "make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "codespell", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["echo -e \"unknwon\nreferer\nerrorstring\neror\niam\nwan\" \u003e words_to_ignore.txt", "codespell -I words_to_ignore.txt docs/", "rm words_to_ignore.txt"]}, {"name": "shellcheck", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl shellcheck"]}, {"name": "lint-backend", "image": "grafana/build-container:1.4.9", "environment": {"CGO_ENABLED": "1"}, "depends_on": ["initialize"], "commands": ["./bin/grabpl lint-backend --edition enterprise"]}, {"name": "lint-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run prettier:check", "yarn run lint", "yarn run i18n:compile", "yarn run typecheck"]}, {"name": "test-backend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl test-backend --edition enterprise"]}, {"name": "test-backend-integration", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl integration-tests --edition enterprise"]}, {"name": "test-frontend", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"TEST_MAX_WORKERS": "50%"}, "commands": ["yarn run ci:test-frontend"]}, {"name": "lint-backend-enterprise2", "image": "grafana/build-container:1.4.9", "environment": {"CGO_ENABLED": "1"}, "depends_on": ["initialize"], "commands": ["./bin/grabpl lint-backend --edition enterprise2"]}, {"name": "test-backend-enterprise2", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl test-backend --edition enterprise2"]}, {"name": "test-backend-integration-enterprise2", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "commands": ["./bin/grabpl integration-tests --edition enterprise2"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}, "image_pull_secrets": ["dockerconfigjson"], "clone": {"disable": true}}
---
{"kind": "pipeline", "type": "docker", "name": "enterprise-integration-tests-release-branch", "trigger": {"ref": ["refs/heads/v[0-9]*"]}, "services": [{"name": "postgres", "image": "postgres:12.3-alpine", "environment": {"POSTGRES_USER": "grafanatest", "POSTGRES_PASSWORD": "grafanatest", "POSTGRES_DB": "grafanatest", "PGDATA": "/var/lib/postgresql/data/pgdata"}, "volumes": [{"name": "postgres", "path": "/var/lib/postgresql/data/pgdata"}]}, {"name": "mysql", "image": "mysql:5.6.48", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql", "path": "/var/lib/mysql"}]}, {"name": "redis", "image": "redis:6.2.1-alpine", "environment": {}}, {"name": "memcached", "image": "memcached:1.6.9-alpine", "environment": {}}], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.15", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "clone-enterprise", "image": "grafana/build-container:1.4.9", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\"", "cd grafana-enterprise", "git checkout ${DRONE_BRANCH}"]}, {"name": "initialize", "image": "grafana/build-container:1.4.9", "depends_on": ["clone-enterprise"], "environment": {}, "commands": ["mv bin/grabpl /tmp/", "rmdir bin", "mv grafana-enterprise /tmp/", "/tmp/grabpl init-enterprise  /tmp/grafana-enterprise", "mv /tmp/grafana-enterprise/deployment_tools_config.json deployment_tools_config.json", "mkdir bin", "mv /tmp/grabpl bin/", "make gen-go", "./bin/grabpl gen-version --build-id ${DRONE_BUILD_NUMBER}", "yarn install --immutable"]}, {"name": "postgres-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"PGPASSWORD": "grafanatest", "GRAFANA_TEST_DB": "postgres", "POSTGRES_HOST": "postgres"}, "commands": ["apt-get update", "apt-get install -yq postgresql-client", "dockerize -wait tcp://postgres:5432 -timeout 120s", "psql -p 5432 -h postgres -U grafanatest -d grafanatest -f devenv/docker/blocks/postgres_tests/setup.sql", "go clean -testcache", "./bin/grabpl integration-tests --database postgres"]}, {"name": "mysql-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql"}, "commands": ["apt-get update", "apt-get install -yq default-mysql-client", "dockerize -wait tcp://mysql:3306 -timeout 120s", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql -P 3306 -u root -prootpass", "go clean -testcache", "./bin/grabpl integration-tests --database mysql"]}, {"name": "redis-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"REDIS_URL": "redis://redis:6379/0"}, "commands": ["dockerize -wait tcp://redis:6379/0 -timeout 120s", "./bin/grabpl integration-tests"]}, {"name": "memcached-integration-tests", "image": "grafana/build-container:1.4.9", "depends_on": ["initialize"], "environment": {"MEMCACHED_HOSTS": "memcached:11211"}, "commands": ["dockerize -wait tcp://memcached:11211 -timeout 120s", "./bin/grabpl integration-tests"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql", "temp": {"medium": "memory"}}], "depends_on": [], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}, "image_pull_secrets": ["dockerconfigjson"], "clone": {"disable": true}}
---
{"kind": "pipeline", "type": "docker", "name": "enterprise-windows-release-branch", "trigger": {"ref": ["refs/heads/v[0-9]*"]}, "services": [], "steps": [{"name": "identify-runner", "image": "mcr.microsoft.com/windows:1809", "commands": ["echo $env:DRONE_RUNNER_NAME"]}, {"name": "clone", "image": "grafana/ci-wix:0.1.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["$$ProgressPreference = \"SilentlyContinue\"", "Invoke-WebRequest https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v2.9.0/windows/grabpl.exe -OutFile grabpl.exe", "git clone \"https://$$env:GITHUB_TOKEN@github.com/grafana/grafana-enterprise.git\"", "cd grafana-enterprise", "git checkout $$env:DRONE_BRANCH"]}, {"name": "initialize", "image": "grafana/ci-wix:0.1.1", "commands": ["cp -r grafana-enterprise C:\\App\\grafana-enterprise", "rm -r -force grafana-enterprise", "cp grabpl.exe C:\\App\\grabpl.exe", "rm -force grabpl.exe", "C:\\App\\grabpl.exe init-enterprise --github-token $$env:GITHUB_TOKEN C:\\App\\grafana-enterprise", "cp C:\\App\\grabpl.exe grabpl.exe"], "depends_on": ["clone"], "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}}, {"name": "build-windows-installer", "image": "grafana/ci-wix:0.1.1", "environment": {"GCP_KEY": {"from_secret": "gcp_key"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}, "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["$$gcpKey = $$env:GCP_KEY", "[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($$gcpKey)) > gcpkey.json", "dos2unix gcpkey.json", "gcloud auth activate-service-account --key-file=gcpkey.json", "rm gcpkey.json", "cp C:\\App\\nssm-2.24.zip ."], "depends_on": ["initialize"]}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["enterprise-build-e2e-publish-release-branch", "enterprise-test-release-branch", "enterprise-integration-tests-release-branch"], "platform": {"os": "windows", "arch": "amd64", "version": "1809"}, "image_pull_secrets": ["dockerconfigjson"], "clone": {"disable": true}}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "scan-grafana/grafana:latest-image", "trigger": {"event": "cron", "cron": "nightly"}, "steps": [{"name": "scan-unkown-low-medium-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/grafana:latest"]}, {"name": "scan-high-critical-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy --exit-code 1 --severity HIGH,CRITICAL grafana/grafana:latest"]}, {"name": "slack-notify-failure", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook_backend"}, "channel": "grafana-backend-ops", "template": "Nightly docker image scan job for grafana/grafana:latest failed: {{build.link}}"}, "when": {"status": "failure"}}]}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "scan-grafana/grafana:main-image", "trigger": {"event": "cron", "cron": "nightly"}, "steps": [{"name": "scan-unkown-low-medium-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/grafana:main"]}, {"name": "scan-high-critical-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy --exit-code 1 --severity HIGH,CRITICAL grafana/grafana:main"]}, {"name": "slack-notify-failure", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook_backend"}, "channel": "grafana-backend-ops", "template": "Nightly docker image scan job for grafana/grafana:main failed: {{build.link}}"}, "when": {"status": "failure"}}]}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "scan-grafana/grafana:latest-ubuntu-image", "trigger": {"event": "cron", "cron": "nightly"}, "steps": [{"name": "scan-unkown-low-medium-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/grafana:latest-ubuntu"]}, {"name": "scan-high-critical-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy --exit-code 1 --severity HIGH,CRITICAL grafana/grafana:latest-ubuntu"]}, {"name": "slack-notify-failure", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook_backend"}, "channel": "grafana-backend-ops", "template": "Nightly docker image scan job for grafana/grafana:latest-ubuntu failed: {{build.link}}"}, "when": {"status": "failure"}}]}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "scan-grafana/grafana:main-ubuntu-image", "trigger": {"event": "cron", "cron": "nightly"}, "steps": [{"name": "scan-unkown-low-medium-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/grafana:main-ubuntu"]}, {"name": "scan-high-critical-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy --exit-code 1 --severity HIGH,CRITICAL grafana/grafana:main-ubuntu"]}, {"name": "slack-notify-failure", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook_backend"}, "channel": "grafana-backend-ops", "template": "Nightly docker image scan job for grafana/grafana:main-ubuntu failed: {{build.link}}"}, "when": {"status": "failure"}}]}
---
{"kind": "secret", "name": "dockerconfigjson", "get": {"path": "secret/data/common/gcr", "name": ".dockerconfigjson"}}
---
{"kind": "secret", "name": "github_token", "get": {"path": "infra/data/ci/github/grafanabot", "name": "pat"}}
---
{"kind": "secret", "name": "drone_token", "get": {"path": "infra/data/ci/drone", "name": "machine-user-token"}}
---
{"kind": "secret", "name": "prerelease_bucket", "get": {"path": "infra/data/ci/grafana/prerelease", "name": "bucket"}}
---
{"kind": "secret", "name": "gcp_upload_artifacts_key", "get": {"path": "infra/data/ci/grafana/releng/artifacts-uploader-service-account", "name": "credentials.json"}}
